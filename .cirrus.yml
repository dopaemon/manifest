env:
    CIRRUS_CLONE_DEPTH: 1
    BUILD_HOSTNAME: "CirrusCI"
    CIRRUS_WORKING_DIR: "/home/doraemon/"

task:
  name: EFIDroid - Xiaomi Mi 4 (Cancro)
  container:
    image: dopaemon/bionic
    cpu: 4
    memory: 8G

  clone_script:
    - mkdir -p ~/efidroid
    - cd ~/efidroid
    - repo init --depth=1 --no-repo-verify -u https://github.com/dopaemon/manifest.git -b efidroid-legacy -g default,-mips,-darwin,-notdefault
    - mkdir -p .repo/local_manifests
    - repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc --all) || repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc --all)
    - git clone -b xiaomi/cranco --single-branch https://github.com/cancro-dev/device.git device/xiaomi/cancro
    - git clone https://git.savannah.gnu.org/git/parted.git modules/parted
    - git clone https://git.savannah.gnu.org/git/gnulib.git modules/gnulib
    - git clone https://git.savannah.gnu.org/git/grub.git uefi/apps/grub

  setup_script:
    - sudo apt-get update
    - sudo apt-get install -yq acpica-tools autoconf autopoint bash bison build-essential bzip2 cmake diffutils file findutils flex git grep hostname perl python2.7 sed tar xz-utils uuid-dev zlib1g-dev zip curl libtool pkg-config gettext automake
    - sudo ln -sf python2.7 /usr/bin/python

  build_script:
    - cd ~/efidroid
    - source build/envsetup.sh
    - echo 1 | lunch
    - croot
    - mkefidroid
